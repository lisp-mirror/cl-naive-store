<html><head><style type='text/css'>
*.state-0 { background-color: #eeeeee }
*.state-1 { background-color: #aaffaa }
*.state-5 { background-color: #44dd44 }
*.state-2 { background-color: #ffaaaa }
*.state-10 { background-color: #ee6666 }
*.state-15 { color: #aaaaaa; background-color: #eeeeee }
*.state-9,*.state-6 { background-color: #ffffaa }
div.key { margin: 20px; width: 200px }
div.source { width: 88ex; background-color: #eeeeee; padding-left: 5px;
             /* border-style: solid none none none; border-width: 1px;
             border-color: #dddddd */ }

*.line-number { color: #666666; float: left; width: 6ex; text-align: right; margin-right: 1ex; }

table.summary tr.head-row { background-color: #aaaaff }
table.summary tr td.text-cell { text-align: left }
table.summary tr td.main-head { text-align: center }
table.summary tr td { text-align: right }
table.summary tr.even { background-color: #eeeeff }
table.summary tr.subheading { background-color: #aaaaff}
table.summary tr.subheading td { text-align: left; font-weight: bold; padding-left: 5ex; }
</style></head><body><h3>Coverage report: /home/phil/source/naive/cl-naive-store/src/naive-store/documents.lisp <br />
</h3>
<table class='summary'><tr class='head-row'><td width='80px'>Kind</td><td width='80px'>Covered</td><td width='80px'>All</td><td width='80px'>%</td><tr class='odd'><td>expression</td><td>284</td><td>310</td><td> 91.6</td></tr>
<tr class='even'><td>branch</td><td>18</td><td>24</td><td> 75.0</td></tr>
</table><div class='key'><b>Key</b><br />
<div class='state-0'>Not instrumented</div><div class='state-15'>Conditionalized out</div><div class='state-1'>Executed</div><div class='state-2'>Not executed</div><div>&#160;</div><div class='state-5'>Both branches taken</div><div class='state-6'>One branch taken</div><div class='state-10''>Neither branch taken</div></div><nobr><div><code>
</code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>1</code></div><code>&#160;<span class='state-2'>&#40;in&#45;package&#160;&#58;cl&#45;naive&#45;store&#46;naive&#45;core&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>2</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>3</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;document&#45;values&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>4</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Returns&#160;a&#160;plist&#160;of&#160;document&#160;values&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>5</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>6</code></div><code>&#160;<span class='state-2'>NOTES&#58;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>7</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>8</code></div><code>&#160;<span class='state-2'>Exists&#160;to&#160;ease&#160;the&#160;compatibility&#160;of&#160;various&#160;implementation&#160;functions&#46;&#160;Basically&#160;it&#160;blurs&#160;the&#160;line&#160;between&#160;plists&#160;and&#160;more&#160;complex&#160;documents&#160;like&#160;cl&#45;naive&#45;store&#46;naive&#45;documents&#160;document&#160;struct&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>9</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>10</code></div><code>&#160;<span class='state-2'>This&#160;helps&#160;keep&#160;the&#160;amount&#160;of&#160;specializations&#160;needed&#160;down&#160;considerably&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>11</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>12</code></div><code>&#160;<span class='state-0'>&#59;&#59;TODO&#58;&#160;Add&#160;a&#160;setf</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>13</code></div><code>&#160;<span class='state-2'>&#40;defmethod&#160;document&#45;values&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>14</code></div><code>&#160;<span class='state-2'>&#160;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>15</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>16</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;key&#45;values&#160;&#40;collection&#160;values&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>17</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Returns&#160;a&#160;set&#160;of&#160;key&#160;values&#160;from&#160;the&#160;values&#160;of&#160;a&#160;data&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>18</code></div><code>&#160;<span class='state-2'>Checks&#160;the&#160;collection&#160;keys&#160;or&#160;uses&#160;hash&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>19</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>20</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;key&#45;values&#160;&#40;&#40;collection&#160;collection&#41;&#160;values&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>21</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;loop</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>22</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#58;for&#160;&#40;a&#160;b&#41;&#160;&#58;on&#160;values&#160;&#58;by&#160;&#35;&#39;cddr</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>23</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#58;when&#160;</span><span class='state-5'>&#40;member&#160;</span><span class='state-1'>a</span><span class='state-5'>&#160;</span><span class='state-1'>&#40;keys&#160;collection&#41;</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>24</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#58;do&#160;&#40;return&#160;&#40;list&#160;&#40;list&#160;a&#160;b&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>25</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#58;unless&#160;</span><span class='state-5'>&#40;or&#160;</span><span class='state-1'>&#40;equalp&#160;a&#160;&#58;hash&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>26</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-5'>&#160;&#160;&#160;&#160;</span><span class='state-1'>&#40;equalp&#160;a&#160;&#58;deleted&#45;p&#41;</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>27</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#58;collect&#160;&#40;list&#160;a&#160;b&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>28</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>29</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;existing&#45;document&#160;&#40;collection&#160;&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>30</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Finds&#160;any&#160;documents&#160;with&#160;the&#160;same&#160;key&#160;values&#46;&#160;This&#160;could&#160;return&#160;the&#160;exact&#160;same&#160;document&#160;or&#160;a&#160;similar&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>31</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>32</code></div><code>&#160;<span class='state-2'>If&#160;a&#160;shard&#160;is&#160;passed&#160;in&#160;then&#160;the&#160;search&#160;is&#160;limited&#160;to&#160;that&#160;shard&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>33</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>34</code></div><code>&#160;<span class='state-2'>IMPL&#160;NOTES&#58;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>35</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>36</code></div><code>&#160;<span class='state-2'>This&#160;is&#160;an&#160;essential&#160;part&#160;of&#160;loading&#160;and&#160;persisting&#160;documents&#44;&#160;take&#160;care&#160;when&#160;implementing&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>37</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>38</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;existing&#45;document&#160;&#40;collection&#160;document&#160;&#38;key</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>39</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;shard&#160;&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>40</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>41</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>42</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;position&#160;&#40;position&#160;&#40;key&#45;values&#160;collection&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>43</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;documents&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>44</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;test&#160;&#40;function&#160;equalp&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>45</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#160;&#40;lambda&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>46</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;key&#45;values&#160;collection&#160;document&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>47</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>48</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;values&#160;&#40;and&#160;position&#160;&#40;elt&#160;&#40;documents&#160;shard&#41;&#160;position&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>49</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;position&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>50</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>51</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;deleted&#45;p&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>52</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Indicates&#160;if&#160;a&#160;data&#160;document&#160;has&#160;been&#160;marked&#160;as&#160;deleted&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>53</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>54</code></div><code>&#160;<span class='state-2'>naive&#45;store&#160;writes&#160;data&#160;to&#160;file&#160;sequentially&#160;and&#160;when&#160;deleting&#160;data&#160;documents&#160;it&#160;does&#160;not&#160;remove&#160;a&#160;data&#160;document&#160;from&#160;the&#160;underlying&#160;file&#160;it&#160;just&#160;marks&#160;it&#160;as&#160;deleted&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>55</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>56</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;deleted&#45;p&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>57</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;getx&#160;document&#160;&#58;deleted&#45;p&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>58</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>59</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;&#40;setf&#160;deleted&#45;p&#41;&#160;&#40;value&#160;document&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>60</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>61</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;&#40;setf&#160;deleted&#45;p&#41;&#160;&#40;value&#160;document&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>62</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;setf&#160;&#40;getx&#160;document&#160;&#58;deleted&#45;p&#41;&#160;value&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>63</code></div><code>&#160;<span class='state-1'>&#160;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>64</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>65</code></div><code>&#160;<span class='state-1'>&#40;defun&#160;ensure&#45;shard&#160;&#40;shard&#160;collection&#160;mac&#160;&#38;optional&#160;where&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>66</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>67</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;shard&#160;&#40;get&#45;shard&#160;collection&#160;mac&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>68</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>69</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;let&#160;&#40;&#40;shardx</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>70</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;make&#45;shard&#160;collection&#160;mac&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>71</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;Make&#160;sure&#160;there&#160;is&#160;nothing&#160;to&#160;load&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>72</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;shardx&#160;&#40;shards&#160;collection&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>73</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;set&#45;shard&#45;cache&#45;safe&#37;&#160;collection&#160;mac&#160;shardx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>74</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;&#160;&#160;&#160;&#160;&#160;&#160;&#40;break&#160;&#34;&#126;S&#34;&#160;shardx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>75</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;load&#45;shard&#160;collection&#160;shardx&#160;&#40;location&#160;shardx&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>76</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;shard&#160;shardx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>77</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;debug&#45;log&#160;&#34;created&#160;new&#160;shard&#126;&#64;&#91;&#160;in&#160;&#126;A&#126;&#93;&#34;&#160;where&#160;&#58;file&#45;p&#160;t&#160;&#58;args&#160;mac&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>78</code></div><code>&#160;<span class='state-1'>&#160;&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>79</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>80</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;remove&#45;document&#160;&#40;collection&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>81</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Removes&#160;an&#160;document&#160;from&#160;the&#160;collection&#160;and&#160;its&#160;indexes&#46;&#160;See&#160;add&#45;document&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>82</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>83</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;remove&#45;document&#160;&#58;around&#160;&#40;&#40;collection&#160;collection&#41;&#160;document&#160;&#38;rest&#160;other&#45;keys&#160;&#38;key&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>84</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>85</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;setf&#160;shard&#160;&#40;ensure&#45;shard&#160;shard&#160;collection&#160;&#40;document&#45;shard&#45;mac&#160;collection&#160;document&#41;&#160;&#39;remove&#45;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>86</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;bt&#58;with&#45;lock&#45;held&#160;&#40;&#40;getx&#160;&#40;lock&#160;shard&#41;&#160;&#58;docs&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>87</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;apply&#160;&#40;function&#160;call&#45;next&#45;method&#41;&#160;collection&#160;document&#160;&#58;shard&#160;shard&#160;other&#45;keys&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>88</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>89</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;remove&#45;document&#160;&#40;&#40;collection&#160;collection&#41;&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>90</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#42;&#160;&#40;&#40;documents&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>91</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;index&#160;&#160;&#160;&#160;&#160;&#40;position&#160;&#40;if&#160;</span><span class='state-9'>&#40;keys&#160;</span><span class='state-1'>collection</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>92</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;key&#45;values&#160;collection&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>93</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>94</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;documents</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>95</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;test&#160;&#35;&#39;equalp</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>96</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#160;&#40;lambda&#160;&#40;documentx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>97</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-9'>&#40;keys&#160;</span><span class='state-1'>collection</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>98</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;key&#45;values&#160;collection&#160;documentx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>99</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;documentx&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>100</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;when&#160;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>101</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;replace&#160;documents&#160;documents</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>102</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;start1&#160;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>103</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;start2&#160;&#40;1&#43;&#160;index&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>104</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;end2&#160;&#40;length&#160;documents&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>105</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;aref&#160;documents&#160;&#40;1&#45;&#160;&#40;length&#160;documents&#41;&#41;&#41;&#160;nil&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>106</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;decf&#160;&#40;fill&#45;pointer&#160;documents&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>107</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>108</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;delete&#45;document&#160;&#40;collection&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>109</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Removes&#160;a&#160;document&#160;from&#160;the&#160;collection&#44;&#160;marks&#160;the&#160;document&#160;as&#160;deleted&#160;and&#160;persists&#160;the&#160;deleted&#160;document&#160;to&#160;disk&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>110</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>111</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;delete&#45;document&#160;&#40;&#40;collection&#160;collection&#41;&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>112</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;setf&#160;shard&#160;&#40;ensure&#45;shard&#160;shard&#160;collection&#160;&#40;document&#45;shard&#45;mac&#160;collection&#160;document&#41;&#160;&#39;delete&#45;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>113</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;remove&#45;document&#160;collection&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>114</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;setf&#160;&#40;deleted&#45;p&#160;document&#41;&#160;t&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>115</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;persist&#45;document&#160;collection&#160;document&#160;&#58;delete&#45;p&#160;t&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>116</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>117</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;add&#45;document&#160;&#40;collection&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>118</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Adds&#160;a&#160;document&#160;to&#160;the&#160;collection&#44;&#160;it&#160;DOES&#160;NOT&#160;PERSIST&#160;the&#160;change&#44;&#160;if&#160;you&#160;want&#160;adding&#160;with&#160;persistance&#160;use&#160;persist&#45;document&#160;or&#160;persist&#160;the&#160;collection&#160;as&#160;a&#160;whole&#160;after&#160;you&#160;have&#160;done&#160;your&#160;adding&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>119</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>120</code></div><code>&#160;<span class='state-2'>Supply&#160;the&#160;shard&#160;the&#160;document&#160;should&#160;belong&#160;to&#160;if&#160;you&#160;can&#44;&#160;especially&#160;if&#160;you&#160;have&#160;a&#160;lot&#160;of&#160;documents&#160;to&#160;add&#160;to&#160;a&#160;specific&#160;shard&#46;&#160;If&#160;not&#160;supplied&#160;the&#160;&#40;shard&#45;elements&#160;collection&#41;&#160;will&#160;be&#160;used&#160;to&#160;calculate&#160;which&#160;shard&#160;to&#160;use&#160;for&#160;the&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>121</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>122</code></div><code>&#160;<span class='state-2'>add&#45;document&#160;returns&#160;multiple&#160;values&#58;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>123</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>124</code></div><code>&#160;<span class='state-2'>The&#160;first&#160;returned&#160;value&#160;is&#160;the&#160;actual&#160;document&#160;supplied&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>125</code></div><code>&#160;<span class='state-2'>The&#160;second&#160;returned&#160;value&#160;indicates&#160;what&#160;action&#160;was&#160;taken&#160;ie&#46;&#160;was&#160;it&#160;added&#160;newly&#160;or&#160;was&#160;an&#160;exiting&#160;document&#160;replaced&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>126</code></div><code>&#160;<span class='state-2'>The&#160;third&#160;returned&#160;value&#160;is&#160;the&#160;replaced&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>127</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>128</code></div><code>&#160;<span class='state-2'>NOTES&#58;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>129</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>130</code></div><code>&#160;<span class='state-2'>In&#160;general&#160;you&#160;should&#160;not&#160;be&#160;calling&#160;add&#45;document&#160;directly&#44;&#160;you&#160;should&#160;use&#160;persist&#45;document&#46;&#160;Calling&#160;add&#45;document&#160;directly&#160;is&#160;allowed&#160;so&#160;you&#160;can&#160;create&#160;temporary&#160;collections&#160;that&#160;can&#160;be&#160;thrown&#160;away&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>131</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>132</code></div><code>&#160;<span class='state-2'>cl&#45;naive&#45;store&#160;does&#160;not&#160;have&#160;a&#160;update&#45;document&#160;function&#44;&#160;add&#45;document&#160;does&#160;both&#160;and&#160;its&#160;behaviour&#160;can&#160;be&#160;complex&#160;depending&#160;on&#160;the&#160;key&#160;parameters&#160;supplied&#46;&#160;Also&#160;the&#160;behaviour&#160;can&#160;differ&#160;for&#160;different&#160;types&#160;of&#160;collections&#46;&#160;Check&#160;the&#160;appropriate&#160;collection&#160;documentation&#160;for&#160;more&#160;details&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>133</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>134</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;add&#45;document&#160;&#40;&#40;collection&#160;collection&#41;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>135</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;key&#160;&#40;shard&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>136</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;handle&#45;duplicates&#45;p&#160;t&#41;</span><span class='state-1'>&#160;</span><span class='state-2'>&#40;replace&#45;existing&#45;p&#160;t&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>137</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>138</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>139</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#34;None&#160;of&#160;the&#160;following&#160;will&#160;have&#160;an&#160;effect&#160;if&#160;handle&#45;duplicates&#160;&#61;&#160;nil&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>140</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>141</code></div><code>&#160;<span class='state-1'>If&#160;a&#160;document&#160;with&#160;the&#160;same&#160;keys&#160;exists&#160;in&#160;the&#160;collection&#160;the&#160;supplied&#160;the&#160;existing&#160;document&#160;will&#160;be&#160;replaced&#160;with&#160;the&#160;supplied&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>142</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>143</code></div><code>&#160;<span class='state-1'>If&#160;you&#160;set&#160;replace&#45;existing&#45;p&#160;to&#160;nil&#160;then&#160;an&#160;existing&#160;document&#160;wont&#160;be&#160;replaced&#160;by&#160;the&#160;supplied&#160;document&#46;&#160;Basically&#160;nothing&#160;will&#160;be&#160;done&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>144</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>145</code></div><code>&#160;<span class='state-1'>Note&#160;that&#160;if&#160;the&#160;document&#160;has&#160;child&#160;documents&#160;that&#160;come&#160;from&#160;another&#160;collection&#160;and&#160;you&#160;changed&#160;them&#160;add&#45;document&#160;will&#160;not&#160;try&#160;to&#160;sync&#160;those&#160;with&#160;existing&#160;documents&#33;&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>146</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>147</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;mac&#160;&#40;document&#45;shard&#45;mac&#160;collection&#160;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>148</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;shard&#160;&#40;ensure&#45;shard&#160;shard&#160;collection&#160;mac&#160;&#39;add&#45;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>149</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>150</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;existing&#45;document&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>151</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;action&#45;taken&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>152</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>153</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;unless&#160;</span><span class='state-9'>&#40;atom&#160;</span><span class='state-6'>&#40;car&#160;</span><span class='state-1'>document</span><span class='state-6'>&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>154</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;error&#160;&#34;There&#160;are&#160;issues&#160;with&#160;the&#160;document&#160;format&#160;it&#160;needs&#160;to&#160;be&#160;a&#160;plist&#46;&#126;&#37;&#126;&#37;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>155</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>156</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>157</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;bt&#58;with&#45;lock&#45;held&#160;&#40;&#40;getx&#160;&#40;lock&#160;shard&#41;&#160;&#58;docs&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>158</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;handle&#45;duplicates&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>159</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;&#160;</span><span class='state-9'>&#40;keys&#160;</span><span class='state-1'>collection</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>160</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;multiple&#45;value&#45;bind&#160;&#40;existing&#45;document&#160;position&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>161</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;existing&#45;document&#160;collection&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>162</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;existing&#45;document&#37;&#160;existing&#45;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>163</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-5'>&#40;and&#160;position&#160;replace&#45;existing&#45;p&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>164</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>165</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;elt&#160;&#40;documents&#160;shard&#41;&#160;position&#41;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>166</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;replaced&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>167</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>168</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>169</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>170</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>171</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>172</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#41;&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>173</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>174</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>175</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>176</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#45;without&#45;duplicate&#45;check&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>177</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>178</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;values</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>179</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>180</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;action&#45;taken</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>181</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-5'>&#40;equalp&#160;</span><span class='state-1'>action&#45;taken</span><span class='state-5'>&#160;</span><span class='state-1'>&#58;replaced</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>182</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;existing&#45;document&#37;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>183</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>184</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;persist&#45;document&#160;&#40;collection&#160;document&#45;form&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>185</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Traverses&#160;the&#160;document&#160;and&#160;composes&#160;a&#160;list&#160;representation&#160;that&#160;is&#160;written&#160;to&#160;file&#46;&#160;If&#160;the&#160;document&#160;is&#160;new&#160;it&#160;is&#160;added&#160;to&#160;the&#160;collection&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>186</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>187</code></div><code>&#160;<span class='state-2'>The&#160;shard&#160;the&#160;document&#160;should&#160;belong&#160;to&#160;can&#160;be&#160;passed&#160;in&#160;as&#160;well&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>188</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>189</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;persist&#45;document&#160;&#58;before&#160;&#40;collection&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>190</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;declare&#160;&#40;ignorable&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>191</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#59;&#59;Loads&#160;collection&#160;if&#160;not&#160;loaded&#160;yet&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>192</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;if&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>193</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;cl&#45;naive&#45;store&#46;naive&#45;core&#58;&#58;load&#45;shard&#160;collection&#160;shard&#160;nil&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>194</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;load&#45;data&#160;collection&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>195</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>196</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;persist&#45;document&#160;&#40;&#40;collection&#160;collection&#41;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>197</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;key&#160;shard&#160;</span><span class='state-2'>&#40;handle&#45;duplicates&#45;p&#160;t&#41;</span><span class='state-1'>&#160;delete&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>198</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;file&#45;name&#160;nil&#160;new&#45;file&#45;p&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>199</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;file&#45;stream&#160;dont&#45;add&#45;to&#45;collection&#45;p&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>200</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>201</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#59;&#59;If&#160;the&#160;file&#160;stream&#160;was&#160;supplied&#160;then&#160;we&#160;are&#160;bulk&#160;persisting&#160;docs</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>202</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#59;&#59;and&#160;the&#160;shard&#160;does&#160;not&#160;matter&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>203</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;unless&#160;</span><span class='state-5'>&#40;or&#160;shard&#160;file&#45;stream&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>204</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;shard&#160;&#40;ensure&#45;shard&#160;shard&#160;collection</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>205</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;document&#45;shard&#45;mac&#160;collection&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>206</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;persist&#45;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>207</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>208</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#42;&#160;&#40;&#40;documentx&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>209</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;sexp&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>210</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>211</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;If&#160;the&#160;file&#160;stream&#160;was&#160;supplied&#160;then&#160;we&#160;are&#160;bulk&#160;persisting&#160;docs</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>212</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;from&#160;a&#160;collection&#160;and&#160;a&#160;deleted&#160;doc&#160;wont&#160;be&#160;in&#160;the&#160;collection&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>213</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;if&#160;file&#45;stream</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>214</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;documentx&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>215</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;documentx&#160;&#40;if&#160;</span><span class='state-5'>&#40;or&#160;delete&#45;p&#160;</span><span class='state-1'>&#40;getx&#160;document&#160;&#58;deleted&#45;p&#41;</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>216</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>217</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;remove&#45;document&#160;collection&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>218</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>219</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;Speads&#160;up&#160;persisting&#160;of&#160;docs&#160;from&#160;an&#160;existing</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>220</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;collection&#160;so&#160;shit&#160;does&#160;not&#160;need&#160;to&#160;be&#160;added&#160;to</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>221</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;collection&#160;again&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>222</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-9'>&#40;not&#160;dont&#45;add&#45;to&#45;collection&#45;p&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>223</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;add&#45;document&#160;collection&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>224</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;handle&#45;duplicates&#45;p&#160;handle&#45;duplicates&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>225</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>226</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>227</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>228</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;sexp&#160;&#40;naive&#45;impl&#58;persist&#45;parse&#160;collection&#160;shard&#160;documentx&#160;nil&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>229</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>230</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;cond</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>231</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;file&#45;stream</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>232</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;write&#45;to&#45;stream&#160;file&#45;stream&#160;sexp&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>233</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;new&#45;file&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>234</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;write&#45;to&#45;file&#160;file&#45;name&#160;sexp&#160;&#58;if&#45;exists&#160;&#58;supersede&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>235</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;t</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>236</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;write&#45;to&#45;file&#160;&#40;location&#160;shard&#41;&#160;sexp&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>237</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;document&#41;&#41;</code></div></body></html>