<html><head><style type='text/css'>
*.state-0 { background-color: #eeeeee }
*.state-1 { background-color: #aaffaa }
*.state-5 { background-color: #44dd44 }
*.state-2 { background-color: #ffaaaa }
*.state-10 { background-color: #ee6666 }
*.state-15 { color: #aaaaaa; background-color: #eeeeee }
*.state-9,*.state-6 { background-color: #ffffaa }
div.key { margin: 20px; width: 200px }
div.source { width: 88ex; background-color: #eeeeee; padding-left: 5px;
             /* border-style: solid none none none; border-width: 1px;
             border-color: #dddddd */ }

*.line-number { color: #666666; float: left; width: 6ex; text-align: right; margin-right: 1ex; }

table.summary tr.head-row { background-color: #aaaaff }
table.summary tr td.text-cell { text-align: left }
table.summary tr td.main-head { text-align: center }
table.summary tr td { text-align: right }
table.summary tr.even { background-color: #eeeeff }
table.summary tr.subheading { background-color: #aaaaff}
table.summary tr.subheading td { text-align: left; font-weight: bold; padding-left: 5ex; }
</style></head><body><h3>Coverage report: /home/phil/source/naive/cl-naive-store/src/naive-indexed/naive-indexed.lisp <br />
</h3>
<table class='summary'><tr class='head-row'><td width='80px'>Kind</td><td width='80px'>Covered</td><td width='80px'>All</td><td width='80px'>%</td><tr class='odd'><td>expression</td><td>329</td><td>454</td><td> 72.5</td></tr>
<tr class='even'><td>branch</td><td>20</td><td>34</td><td> 58.8</td></tr>
</table><div class='key'><b>Key</b><br />
<div class='state-0'>Not instrumented</div><div class='state-15'>Conditionalized out</div><div class='state-1'>Executed</div><div class='state-2'>Not executed</div><div>&#160;</div><div class='state-5'>Both branches taken</div><div class='state-6'>One branch taken</div><div class='state-10''>Neither branch taken</div></div><nobr><div><code>
</code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>1</code></div><code>&#160;<span class='state-2'>&#40;in&#45;package&#160;&#58;cl&#45;naive&#45;store&#46;naive&#45;indexed&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>2</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>3</code></div><code>&#160;<span class='state-0'>&#59;&#59;TODO&#58;&#160;Doing&#160;partial&#45;indexing&#160;doubles&#160;the&#160;time&#160;it&#160;takes&#160;to&#160;load&#160;a&#160;database</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>4</code></div><code>&#160;<span class='state-0'>&#59;&#59;Try&#160;to&#160;delay&#160;or&#160;spool&#160;of&#160;partial&#160;indexing&#160;on&#160;different&#160;thread&#46;</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>5</code></div><code>&#160;<span class='state-2'>&#40;defparameter&#160;&#42;do&#45;partial&#45;indexing&#42;&#160;t</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>6</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#34;When&#160;this&#160;is&#160;set&#160;to&#160;t&#160;&#40;which&#160;is&#160;the&#160;default&#41;&#44;&#160;indexing&#160;is&#160;done&#160;for&#160;the&#160;individual&#160;elements&#160;of&#160;the&#160;indexes&#160;as&#160;well&#46;&#34;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>7</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>8</code></div><code>&#160;<span class='state-2'>&#40;defclass&#160;indexed&#45;shard&#160;&#40;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>9</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#40;hash&#45;index&#160;&#58;initarg&#160;&#58;hash&#45;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>10</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;accessor&#160;hash&#45;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>11</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;initform&#160;nil</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>12</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;documentation&#160;&#34;Hash&#160;table&#160;keyed&#160;on&#160;document&#160;uuid&#160;for&#160;quick&#160;retrieval&#160;of&#160;an&#160;document&#160;and&#160;its&#160;actual&#160;position&#160;in&#160;the&#160;documents&#160;vector&#160;of&#160;the&#160;shard&#46;&#34;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>13</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#40;key&#45;value&#45;index&#160;&#58;initarg&#160;&#58;key&#45;value&#45;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>14</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;accessor&#160;key&#45;value&#45;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>15</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;initform&#160;nil</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>16</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;documentation&#160;&#34;Hash&#160;table&#160;keyed&#160;on&#160;document&#160;key&#160;values&#160;for&#160;quick&#160;retrieval&#160;of&#160;an&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>17</code></div><code>&#160;<span class='state-2'>Used&#160;when&#160;doing&#160;key&#160;value&#160;equality&#160;comparisons&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>18</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>19</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Extends&#160;shards&#160;with&#160;indexes&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>20</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>21</code></div><code>&#160;<span class='state-2'>&#40;defmethod&#160;clear&#45;documents&#160;&#40;&#40;shard&#160;indexed&#45;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>22</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;call&#45;next&#45;method&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>23</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;when&#160;</span><span class='state-10'>&#40;hash&#45;index&#160;</span><span class='state-2'>shard</span><span class='state-10'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>24</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;clrhash&#160;&#40;hash&#45;index&#160;shard&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>25</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;when&#160;</span><span class='state-10'>&#40;key&#45;value&#45;index&#160;</span><span class='state-2'>shard</span><span class='state-10'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>26</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;clrhash&#160;&#40;key&#45;value&#45;index&#160;shard&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>27</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>28</code></div><code>&#160;<span class='state-2'>&#40;defclass&#160;indexed&#45;collection&#45;mixin&#160;&#40;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>29</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#40;indexes&#160;&#58;initarg&#160;&#58;indexes</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>30</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;accessor&#160;indexes</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>31</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;initform&#160;nil</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>32</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;documentation&#160;&#34;List&#160;of&#160;index&#160;combinations&#46;&#160;Also&#160;indexes&#160;members&#160;partially&#160;if&#160;&#42;partial&#45;indexing&#42;&#160;is&#160;t&#44;&#160;for&#160;example&#160;&#39;&#40;&#40;&#58;emp&#45;no&#160;&#58;surname&#160;gender&#41;&#41;&#160;is&#160;indexed&#160;as&#160;&#40;&#58;emp&#45;no&#160;&#58;surname&#160;&#58;gender&#41;&#44;&#160;&#40;&#58;emp&#45;no&#160;&#58;surname&#41;&#44;&#160;&#58;emp&#45;no&#44;&#160;&#58;surname&#160;and&#160;&#58;gender&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>33</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Collection&#160;extension&#160;to&#160;add&#160;very&#160;basic&#160;indexes&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>34</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>35</code></div><code>&#160;<span class='state-2'>&#40;defclass&#160;indexed&#45;collection&#160;&#40;indexed&#45;collection&#45;mixin&#160;collection&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>36</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>37</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>38</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;make&#45;shard&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;&#160;shard&#45;mac&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>39</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;make&#45;instance&#160;&#39;indexed&#45;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>40</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;mac&#160;&#40;or&#160;shard&#45;mac&#160;</span><span class='state-2'>&#40;name&#160;collection&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>41</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;location&#160;&#40;cl&#45;fad&#58;merge&#45;pathnames&#45;as&#45;file</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>42</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;pathname&#160;&#40;ensure&#45;location&#160;collection&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>43</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;make&#45;pathname&#160;&#59;&#59;&#58;directory&#160;&#40;list&#160;&#58;relative&#160;&#40;name&#160;collection&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>44</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;name&#160;&#40;or&#160;shard&#45;mac&#160;</span><span class='state-2'>&#40;name&#160;collection&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>45</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;type&#160;&#34;log&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>46</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#45;value&#45;index&#160;&#40;make&#45;hash&#45;table</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>47</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;test&#160;&#39;equalp</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>48</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#35;&#43;&#40;or&#160;sbcl&#160;ecl&#41;&#160;&#58;synchronized</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>49</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#35;&#43;&#40;or&#160;sbcl&#160;ecl&#41;&#160;nil&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>50</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;hash&#45;index&#160;&#40;make&#45;hash&#45;table</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>51</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;test&#160;&#39;equalp</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>52</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#35;&#43;&#40;or&#160;sbcl&#160;ecl&#41;&#160;&#58;synchronized</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>53</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#35;&#43;&#40;or&#160;sbcl&#160;ecl&#41;&#160;nil&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>54</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;status&#160;&#58;new&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>55</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>56</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;get&#45;shard&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;&#160;shard&#45;mac&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>57</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;cl&#45;naive&#45;store&#46;naive&#45;core&#58;&#58;get&#45;shard&#45;cache&#45;safe&#37;&#160;collection&#160;shard&#45;mac&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>58</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>59</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;hash&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>60</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Returns&#160;the&#160;hash&#160;identifier&#160;for&#160;a&#160;data&#160;document&#46;&#160;Data&#160;documents&#160;need&#160;a&#160;hash&#160;identifier&#160;to&#160;work&#160;with&#160;naive&#45;store&#45;indexed&#46;&#160;naive&#45;store&#45;indexed&#160;will&#160;edit&#160;the&#160;document&#160;to&#160;add&#160;a&#160;hash&#160;identifier&#160;when&#160;adding&#160;documents&#160;to&#160;a&#160;collection&#46;&#160;naive&#45;store&#45;indexed&#160;uses&#160;a&#160;UUID&#160;in&#160;its&#160;default&#160;implementation&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>61</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>62</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;hash&#160;&#40;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>63</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;if&#160;</span><span class='state-5'>&#40;getx&#160;</span><span class='state-1'>document</span><span class='state-5'>&#160;</span><span class='state-1'>&#58;hash</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>64</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;frmt&#160;&#34;&#126;A&#34;&#160;&#40;getx&#160;document&#160;&#58;hash&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>65</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>66</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;&#40;setf&#160;hash&#41;&#160;&#40;value&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>67</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>68</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;&#40;setf&#160;hash&#41;&#160;&#40;value&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>69</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;setf&#160;&#40;getx&#160;document&#160;&#58;hash&#41;&#160;&#40;frmt&#160;&#34;&#126;A&#34;&#160;value&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>70</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>71</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;index&#45;lookup&#45;values&#160;&#40;collection&#160;values&#160;&#38;key&#160;shards&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>72</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Looks&#160;up&#160;document&#160;in&#160;key&#160;value&#160;hash&#160;index&#46;&#160;If&#160;you&#160;are&#160;not&#160;using&#160;document&#45;types&#160;then&#160;the&#160;order&#160;of&#160;values&#160;matter&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>73</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>74</code></div><code>&#160;<span class='state-2'>Will&#160;use&#160;shards&#160;to&#160;limit&#160;the&#160;lookup&#160;to&#160;specific&#160;shards&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>75</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>76</code></div><code>&#160;<span class='state-2'>&#40;defmethod&#160;index&#45;lookup&#45;values&#160;&#40;&#40;collection&#160;collection&#41;&#160;values&#160;&#38;key&#160;shards&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>77</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;declare&#160;&#40;ignorable&#160;collection&#160;values&#160;shards&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>78</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;warn&#160;&#34;Not&#160;implemented&#33;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>79</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>80</code></div><code>&#160;<span class='state-0'>&#59;&#59;TODO&#58;&#160;Do&#160;parallel&#160;processing&#46;&#46;&#46;&#160;this&#160;gets&#160;called&#160;a&#160;lot&#160;so&#160;trying&#160;to&#160;do&#160;parallel</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>81</code></div><code>&#160;<span class='state-0'>&#59;&#59;slows&#160;loading&#160;down&#160;to&#160;a&#160;crawl</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>82</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;index&#45;lookup&#45;values&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>83</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;values&#160;&#38;key&#160;&#40;shards&#160;&#40;and&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>84</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;list&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-1'>&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>85</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>86</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;final&#45;docs&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>87</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;do&#45;sequence&#160;&#40;shard&#160;&#40;or&#160;shards</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>88</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;shards&#160;collection&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>89</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>90</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>91</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;error&#160;&#34;No&#160;shard&#160;for&#160;index&#160;lookup&#160;&#45;&#160;&#126;A&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>92</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;or&#160;&#40;and&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>93</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;list&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>94</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;shards</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>95</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;shards&#160;collection&#41;&#41;&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>96</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>97</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;let&#42;&#160;&#40;&#40;index&#160;&#40;key&#45;value&#45;index&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>98</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;docs&#160;&#40;gethash&#45;safe&#160;&#40;cl&#45;murmurhash&#58;murmurhash&#160;values&#41;&#160;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>99</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;lock&#160;&#40;getx&#160;&#40;lock&#160;shard&#41;&#160;&#58;values&#45;index&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>100</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;docs</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>101</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;final&#45;docs&#160;&#40;append&#160;final&#45;docs&#160;docs&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>102</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>103</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;remove&#45;duplicates&#160;final&#45;docs&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>104</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>105</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;index&#45;lookup&#45;hash&#160;&#40;collection&#160;hash&#160;&#38;key&#160;shards&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>106</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Looks&#160;up&#160;document&#160;in&#160;UUID&#160;hash&#160;index&#46;&#160;If&#160;shards&#160;is&#160;not&#160;supplied&#160;all&#160;loaded&#160;shards&#160;will&#160;be&#160;searched&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>107</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>108</code></div><code>&#160;<span class='state-2'>Returns&#160;document&#160;and&#160;position&#160;as&#160;values&#46;&#160;Position&#160;is&#160;used&#160;in&#160;add&#45;document&#160;to&#160;do&#160;replace&#160;if&#160;needed&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>109</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>110</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;index&#45;lookup&#45;hash&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;&#160;hash</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>111</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;key&#160;&#40;shards&#160;</span><span class='state-2'>&#40;and&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>112</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#40;list&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>113</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>114</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;when&#160;hash</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>115</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;debug&#45;log&#160;&#34;index&#58;index&#45;lookup&#45;hash&#160;&#126;A&#160;hash&#160;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>116</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;name&#160;collection&#41;&#160;hash&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>117</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;TODO&#58;&#160;Parallel&#63;&#63;&#63;&#63;&#63;&#63;&#63;&#63;&#63;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>118</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;map&#160;nil&#160;&#40;lambda&#160;&#40;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>119</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;debug&#45;log&#160;&#34;index&#58;index&#45;lookup&#45;hash&#160;&#126;A&#160;shard&#160;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>120</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;name&#160;collection&#41;&#160;&#40;and&#160;shard&#160;&#40;short&#45;mac&#160;shard&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>121</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>122</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;naive&#45;impl&#58;&#58;debug&#45;log&#160;&#34;index&#58;index&#45;lookup&#45;hash&#160;&#126;A&#160;shard&#160;&#126;S&#160;&#45;&#62;&#160;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>123</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;name&#160;collection&#41;&#160;&#40;and&#160;shard&#160;&#40;short&#45;mac&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>124</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;gethash&#160;hash&#160;&#40;hash&#45;index&#160;shard&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>125</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;let&#160;&#40;&#40;doc&#160;&#40;gethash&#160;hash&#160;&#40;hash&#45;index&#160;shard&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>126</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;doc</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>127</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;return&#45;from&#160;index&#45;lookup&#45;hash&#160;&#40;values&#160;&#40;getx&#160;doc&#160;&#58;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>128</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;getx&#160;doc&#160;&#58;position&#41;&#41;&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>129</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;or&#160;shards&#160;</span><span class='state-2'>&#40;shards&#160;collection&#41;</span><span class='state-1'>&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>130</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>131</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;add&#45;index&#160;&#40;collection&#160;shard&#160;document&#160;position&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>132</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Adds&#160;a&#160;document&#160;to&#160;two&#160;indexes&#46;&#160;The&#160;first&#160;uses&#160;a&#160;UUID&#160;that&#160;will&#160;stay&#160;with&#160;the&#160;document&#160;for&#160;its&#160;life&#160;time&#46;&#160;The&#160;UUID&#160;is&#160;used&#160;when&#160;persisting&#160;the&#160;document&#160;and&#160;is&#160;never&#160;changed&#160;once&#160;created&#46;&#160;This&#160;allows&#160;us&#160;to&#160;change&#160;key&#160;values&#160;without&#160;loosing&#160;the&#160;identify&#160;of&#160;the&#160;original&#160;document&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>133</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>134</code></div><code>&#160;<span class='state-2'>The&#160;second&#160;is&#160;a&#160;key&#160;value&#160;hash&#160;index&#160;to&#160;be&#160;used&#160;when&#160;looking&#160;for&#160;duplicate&#160;documents&#160;during&#160;persist&#46;&#160;If&#160;you&#160;are&#160;not&#160;using&#160;document&#45;types&#160;the&#160;order&#160;of&#160;the&#160;keys&#160;in&#160;the&#160;plist&#160;matter&#46;&#160;To&#160;make&#160;sure&#160;that&#160;you&#160;dont&#160;muck&#160;with&#160;the&#160;order&#160;of&#160;values&#47;keys&#160;in&#160;your&#160;plists&#160;initialize&#160;all&#160;the&#160;possible&#160;value&#160;pairs&#160;with&#160;nil&#160;so&#160;that&#160;way&#160;the&#160;order&#160;is&#160;set&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>135</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>136</code></div><code>&#160;<span class='state-2'>A&#160;shard&#160;must&#160;be&#160;supplied&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>137</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>138</code></div><code>&#160;<span class='state-2'>Position&#160;saved&#160;to&#160;use&#160;with&#160;future&#160;add&#45;document&#160;to&#160;replace&#160;actual&#160;documents&#160;in&#160;the&#160;document&#160;vector&#160;if&#160;needed&#46;&#160;It&#160;is&#160;done&#160;to&#160;speed&#160;up&#160;add&#45;document&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>139</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>140</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;add&#45;index&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;&#160;shard&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>141</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;position&#160;&#38;key&#160;key&#45;values&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>142</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#42;&#160;&#40;&#40;index&#45;values&#160;&#40;indexed&#45;impl&#58;index&#45;values&#160;collection&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>143</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;key&#45;values&#160;&#40;or&#160;key&#45;values&#160;</span><span class='state-2'>&#40;key&#45;values&#160;collection&#160;document&#41;</span><span class='state-1'>&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>144</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>145</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>146</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;setf&#160;shard&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>147</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>148</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;gethash&#45;safe&#160;&#40;hash&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>149</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;hash&#45;index&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>150</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;lock&#160;&#40;getx&#160;&#40;lock&#160;shard&#41;&#160;&#58;hash&#45;index&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>151</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;list&#160;&#58;document&#160;document&#160;&#58;position&#160;position&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>152</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>153</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;TODO&#58;&#160;Check&#160;if&#160;this&#160;is&#160;still&#160;true&#63;&#63;&#63;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>154</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;Used&#160;to&#160;do&#160;document&#160;value&#160;comparisons&#160;to&#160;find&#160;index&#45;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>155</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;&#160;&#40;setf&#160;&#40;gethash&#160;&#40;frmt&#160;&#34;&#126;S&#34;&#160;key&#45;values&#41;&#160;&#40;key&#45;value&#45;index&#160;collection&#41;&#41;&#160;&#40;list&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>156</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;&#58;push&#45;value&#45;index&#160;collection&#160;key&#45;values&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>157</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>158</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;key&#45;values&#160;are&#160;in&#160;effect&#160;their&#160;own&#160;value&#160;index&#160;and&#160;because&#160;it&#160;could&#160;be&#160;completely</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>159</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#59;&#59;different&#160;from&#160;index&#45;values&#160;it&#160;is&#160;added&#160;to&#160;value&#160;indexes&#160;as&#160;well&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>160</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;&#58;populate&#45;value&#45;index&#160;collection&#160;&#40;list&#160;key&#45;values&#41;&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>161</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;&#58;populate&#45;value&#45;index&#160;collection&#160;index&#45;values&#160;document&#160;&#58;shard&#160;shard&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>162</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>163</code></div><code>&#160;<span class='state-2'>&#40;defgeneric&#160;remove&#45;index&#160;&#40;collection&#160;shard&#160;document&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>164</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;&#58;documentation&#160;&#34;Removes&#160;a&#160;data&#160;document&#160;from&#160;the&#160;UUID&#160;and&#160;key&#160;value&#160;indexes&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>165</code></div><code>&#160;<span class='state-2'>A&#160;shard&#160;must&#160;be&#160;supplied&#46;&#34;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>166</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>167</code></div><code>&#160;<span class='state-2'>&#40;defmethod&#160;remove&#45;index&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>168</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;shard&#160;document&#160;&#38;key&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>169</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;let&#160;&#40;&#40;key&#45;values&#160;&#40;key&#45;values&#160;collection&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>170</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;indexes&#45;values&#160;&#40;indexed&#45;impl&#58;index&#45;values&#160;collection&#160;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>171</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>172</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>173</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;error&#160;&#34;No&#160;shard&#160;&#45;&#160;&#126;A&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>174</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;collection&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>175</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>176</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;remove&#45;value&#45;index&#160;collection&#160;shard&#160;key&#45;values&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>177</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;&#58;remove&#45;index&#45;values&#160;collection&#160;shard&#160;&#40;list&#160;key&#45;values&#41;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>178</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;indexed&#45;impl&#58;&#58;remove&#45;index&#45;values&#160;collection&#160;shard&#160;indexes&#45;values&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>179</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>180</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#40;remhash&#160;&#40;hash&#160;document&#41;&#160;&#40;hash&#45;index&#160;shard&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>181</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>182</code></div><code>&#160;<span class='state-2'>&#40;defmethod&#160;remove&#45;document&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>183</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#160;&#38;key&#160;shard&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>184</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;call&#45;next&#45;method&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>185</code></div><code>&#160;<span class='state-2'>&#160;&#160;&#40;remove&#45;index&#160;collection&#160;shard&#160;document&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>186</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>187</code></div><code>&#160;<span class='state-0'>&#59;&#59;TODO&#58;&#160;Need&#160;to&#160;get&#160;rid&#160;of&#160;this&#44;&#160;sort&#160;out&#160;the&#160;duplicates&#160;some&#160;other&#160;way&#33;&#33;&#33;&#160;This&#160;is&#160;called&#160;alot&#46;</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>188</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>189</code></div><code>&#160;<span class='state-0'>&#59;&#59;NOTE&#58;&#160;Doing&#160;this&#160;because&#160;murmurhash&#160;is&#160;creating&#160;duplicates&#160;when&#160;you&#160;go&#160;beyond&#160;10&#160;million&#160;index&#160;values</span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>190</code></div><code>&#160;<span class='state-1'>&#40;defun&#160;try&#45;better&#45;value&#45;match&#160;&#40;collection&#160;list&#160;key&#45;values&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>191</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;dolist&#160;&#40;document&#160;list&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>192</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;when&#160;</span><span class='state-9'>&#40;equalp&#160;</span><span class='state-1'>key&#45;values</span><span class='state-9'>&#160;</span><span class='state-1'>&#40;key&#45;values&#160;collection&#160;document&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>193</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;return&#160;document&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>194</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>195</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;existing&#45;document&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>196</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>197</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;key&#160;</span><span class='state-2'>&#40;shard&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>198</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;key&#45;values&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>199</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>200</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;unless&#160;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>201</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;error&#160;&#34;No&#160;shard&#160;&#45;&#160;&#126;A&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>202</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;collection&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>203</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>204</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#42;&#160;&#40;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>205</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;existing&#45;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>206</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;position&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>207</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>208</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;multiple&#45;value&#45;bind&#160;&#40;doc&#160;position&#45;x&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>209</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;and&#160;</span><span class='state-5'>&#40;hash&#160;</span><span class='state-1'>document</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>210</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;index&#45;lookup&#45;hash&#160;collection&#160;&#40;hash&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>211</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;shards&#160;&#40;and&#160;shard&#160;&#40;list&#160;shard&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>212</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>213</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;doc</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>214</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;setf&#160;existing&#45;document&#160;doc&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>215</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;setf&#160;position&#160;position&#45;x&#41;</span><span class='state-1'>&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>216</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>217</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;unless&#160;existing&#45;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>218</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;let&#160;&#40;&#40;key&#45;values</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>219</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;or&#160;key&#45;values&#160;&#40;key&#45;values&#160;collection&#160;document&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>220</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;existing&#45;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>221</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;try&#45;better&#45;value&#45;match</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>222</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;collection</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>223</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;index&#45;lookup&#45;values&#160;collection&#160;key&#45;values</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>224</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;shards&#160;&#40;and&#160;shard&#160;&#40;list&#160;shard&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>225</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;key&#45;values&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>226</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>227</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;existing&#45;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>228</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;multiple&#45;value&#45;bind&#160;&#40;doc&#160;position&#45;x&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>229</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;and&#160;</span><span class='state-9'>&#40;hash&#160;</span><span class='state-1'>existing&#45;document</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>230</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;index&#45;lookup&#45;hash&#160;collection&#160;&#40;hash&#160;existing&#45;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>231</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;shards&#160;&#40;and&#160;shard&#160;&#40;list&#160;shard&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>232</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>233</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;doc</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>234</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;existing&#45;document&#160;doc&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>235</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;position&#160;position&#45;x&#41;&#41;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>236</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>237</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;values&#160;&#40;and&#160;position</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>238</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;Getting&#160;the&#160;actual&#160;document&#160;just&#160;incase&#160;the&#160;index</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>239</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;and&#160;doc&#160;went&#160;out&#160;of&#160;sync&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>240</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;TODO&#58;&#160;Is&#160;this&#160;really&#160;necessary&#63;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>241</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;elt&#160;&#40;documents&#160;shard&#41;&#160;position&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>242</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;position&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>243</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>244</code></div><code>&#160;<span class='state-1'>&#40;defmethod&#160;add&#45;document&#160;&#40;&#40;collection&#160;indexed&#45;collection&#45;mixin&#41;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>245</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;key&#160;</span><span class='state-2'>&#40;shard&#160;naive&#45;impl&#58;&#37;loading&#45;shard&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>246</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;handle&#45;duplicates&#45;p&#160;t&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>247</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;replace&#45;existing&#45;p&#160;t&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>248</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;update&#45;index&#45;p&#160;t&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>249</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;allow&#45;other&#45;keys&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>250</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#34;Duplicates&#160;are&#160;not&#160;allowed&#160;for&#160;indexed&#160;collections&#33;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>251</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>252</code></div><code>&#160;<span class='state-1'>If&#160;the&#160;document&#160;has&#160;no&#160;hash&#160;and&#160;a&#160;document&#160;with&#160;the&#160;same&#160;keys&#160;exists</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>253</code></div><code>&#160;<span class='state-1'>in&#160;the&#160;collection&#160;the&#160;supplied&#160;document&#39;s&#160;hash&#160;will&#160;be&#160;set&#160;to&#160;that&#160;of</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>254</code></div><code>&#160;<span class='state-1'>the&#160;existing&#160;document&#46;&#160;The&#160;existing&#160;document&#160;will&#160;then&#160;be&#160;replaced</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>255</code></div><code>&#160;<span class='state-1'>with&#160;the&#160;supplied&#160;document&#46;&#160;This&#160;is&#160;done&#160;to&#160;maintain&#160;hash&#160;consistancy</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>256</code></div><code>&#160;<span class='state-1'>of&#160;the&#160;store&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>257</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>258</code></div><code>&#160;<span class='state-1'>If&#160;you&#160;set&#160;replace&#45;existing&#45;p&#160;to&#160;nil&#160;then&#160;an&#160;existing&#160;document&#160;wont&#160;be</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>259</code></div><code>&#160;<span class='state-1'>replaced&#160;by&#160;the&#160;supplied&#160;document&#46;&#160;Basically&#160;nothing&#160;will&#160;be&#160;done&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>260</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>261</code></div><code>&#160;<span class='state-1'>Indexes&#160;will&#160;be&#160;updated&#160;by&#160;default&#44;&#160;if&#160;you&#160;want&#160;to&#160;stop&#160;index&#160;updates</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>262</code></div><code>&#160;<span class='state-1'>set&#160;update&#45;index&#45;p&#160;to&#160;nil&#46;&#160;Just&#160;remember&#160;that&#160;if&#160;the&#160;document&#160;is</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>263</code></div><code>&#160;<span class='state-1'>really&#160;&#92;&#34;new&#92;&#34;&#160;to&#160;the&#160;collection&#160;the&#160;indexes&#160;will&#160;be&#160;updated&#160;in&#160;any</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>264</code></div><code>&#160;<span class='state-1'>case&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>265</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>266</code></div><code>&#160;<span class='state-1'>Note&#160;that&#160;if&#160;the&#160;document&#160;have&#160;child&#160;documents&#160;that&#160;come&#160;from&#160;another</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>267</code></div><code>&#160;<span class='state-1'>collection&#160;and&#160;you&#160;m&#160;changed&#160;them&#160;add&#45;document&#160;will&#160;not&#160;try&#160;to&#160;sync</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>268</code></div><code>&#160;<span class='state-1'>those&#160;with&#160;existing&#160;documents&#33;&#160;That&#160;also&#160;means&#160;that&#160;add&#160;wont&#160;assign</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>269</code></div><code>&#160;<span class='state-1'>uuid&#39;s&#160;to&#160;any&#160;child&#160;documents&#160;that&#160;don&#39;t&#160;have&#160;them&#160;set&#44;&#160;you&#160;have&#160;to</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>270</code></div><code>&#160;<span class='state-1'>set&#160;them&#160;yourself&#46;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>271</code></div><code>&#160;<span class='state-1'>&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>272</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;mac&#160;&#40;document&#45;shard&#45;mac&#160;collection&#160;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>273</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;setf&#160;shard&#160;&#40;cl&#45;naive&#45;store&#46;naive&#45;core&#58;&#58;ensure&#45;shard</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>274</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;shard&#160;collection&#160;mac&#160;&#39;add&#45;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>275</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>276</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;when&#160;</span><span class='state-5'>&#40;listp&#160;</span><span class='state-1'>document</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>277</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;unless&#160;</span><span class='state-9'>&#40;atom&#160;</span><span class='state-6'>&#40;car&#160;</span><span class='state-1'>document</span><span class='state-6'>&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>278</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;error&#160;&#34;There&#160;are&#160;issues&#160;with&#160;the&#160;document&#160;format&#160;it&#160;needs&#160;to&#160;be&#160;a&#160;plist&#46;&#126;&#37;&#126;&#37;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>279</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;document&#41;</span><span class='state-1'>&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>280</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>281</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#40;let&#160;&#40;&#40;existing&#45;document&#37;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>282</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;action&#45;taken&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>283</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;key&#45;values&#160;&#40;key&#45;values&#160;collection&#160;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>284</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>285</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;bt&#58;with&#45;lock&#45;held&#160;&#40;&#40;getx&#160;&#40;lock&#160;shard&#41;&#160;&#58;docs&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>286</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;handle&#45;duplicates&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>287</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-9'>&#40;keys&#160;</span><span class='state-1'>collection</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>288</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;multiple&#45;value&#45;bind&#160;&#40;existing&#45;document&#160;position&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>289</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;existing&#45;document&#160;collection&#160;document&#160;&#58;shard&#160;shard&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>290</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;existing&#45;document&#37;&#160;existing&#45;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>291</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-5'>&#40;and&#160;position&#160;replace&#45;existing&#45;p&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>292</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>293</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#59;&#59;&#160;&#40;break&#160;&#34;&#126;S&#160;&#126;S&#34;&#160;document&#160;existing&#45;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>294</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;</span><span class='state-9'>&#40;naive&#45;impl&#58;empty&#45;p&#160;</span><span class='state-1'>&#40;hash&#160;document&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>295</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;hash&#160;document&#41;&#160;&#40;hash&#160;existing&#45;document&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>296</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;unless&#160;</span><span class='state-9'>&#40;equalp&#160;</span><span class='state-1'>&#40;hash&#160;document&#41;</span><span class='state-9'>&#160;</span><span class='state-1'>&#40;hash&#160;existing&#45;document&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>297</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;error&#160;&#34;Clobbering&#160;document&#160;with&#160;different&#160;hash&#46;&#126;&#37;Existing&#126;&#37;&#126;S&#126;&#37;New&#126;&#37;&#126;S&#34;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>298</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;existing&#45;document&#160;document&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>299</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;update&#45;index&#45;p</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>300</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;add&#45;index&#160;collection&#160;shard&#160;document&#160;position</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>301</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#45;values&#160;key&#45;values&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>302</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;elt&#160;&#40;documents&#160;shard&#41;&#160;position&#41;&#160;document&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>303</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;replaced&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>304</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>305</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>306</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;</span><span class='state-5'>&#40;naive&#45;impl&#58;empty&#45;p&#160;</span><span class='state-1'>&#40;hash&#160;document&#41;</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>307</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;hash&#160;document&#41;&#160;&#40;uuid&#58;make&#45;v4&#45;uuid&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>308</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;add&#45;index&#160;collection&#160;shard&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>309</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>310</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#45;values&#160;key&#45;values&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>311</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>312</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>313</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>314</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#40;when&#160;</span><span class='state-10'>&#40;naive&#45;impl&#58;empty&#45;p&#160;</span><span class='state-2'>&#40;hash&#160;document&#41;</span><span class='state-10'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>315</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;hash&#160;document&#41;&#160;&#40;uuid&#58;make&#45;v4&#45;uuid&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>316</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>317</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#40;add&#45;index&#160;collection&#160;shard&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>318</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>319</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#45;values&#160;key&#45;values&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>320</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>321</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</span><span class='state-2'>&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#41;&#41;</span><span class='state-1'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>322</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;progn</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>323</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;when&#160;</span><span class='state-9'>&#40;naive&#45;impl&#58;empty&#45;p&#160;</span><span class='state-1'>&#40;hash&#160;document&#41;</span><span class='state-9'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>324</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;&#40;hash&#160;document&#41;&#160;&#40;uuid&#58;make&#45;v4&#45;uuid&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>325</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;add&#45;index&#160;collection&#160;shard&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>326</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;vector&#45;push&#45;extend&#160;document&#160;&#40;documents&#160;shard&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>327</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#58;key&#45;values&#160;key&#45;values&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>328</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>329</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#40;setf&#160;action&#45;taken&#160;&#58;added&#45;without&#45;duplicate&#45;check&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>330</code></div><code>&#160;<span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>331</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#40;values</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>332</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;document</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>333</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;action&#45;taken</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>334</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#40;if&#160;</span><span class='state-5'>&#40;equalp&#160;</span><span class='state-1'>action&#45;taken</span><span class='state-5'>&#160;</span><span class='state-1'>&#58;replaced</span><span class='state-5'>&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>335</code></div><code>&#160;<span class='state-1'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;existing&#45;document&#37;&#41;&#41;&#41;&#41;</span><span class='state-0'></span></code></div></nobr>
<nobr><div class='source'><div class='line-number'><code>336</code></div><code>&#160;</code></div></body></html>